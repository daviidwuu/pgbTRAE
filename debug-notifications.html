<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Push Notification Debug Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        pre { background: #f4f4f4; padding: 10px; overflow-x: auto; }
        .status { font-weight: bold; }
    </style>
</head>
<body>
    <h1>üîß Push Notification Debug Tool</h1>
    
    <div class="section">
        <h2>1. Browser Support Check</h2>
        <div id="browser-support"></div>
    </div>

    <div class="section">
        <h2>2. Service Worker Status</h2>
        <div id="sw-status"></div>
        <button onclick="checkServiceWorker()">Check Service Worker</button>
    </div>

    <div class="section">
        <h2>3. Notification Permission</h2>
        <div id="permission-status"></div>
        <button onclick="requestPermission()">Request Permission</button>
    </div>

    <div class="section">
        <h2>4. Push Subscription</h2>
        <div id="subscription-status"></div>
        <button onclick="createSubscription()">Create Subscription</button>
        <button onclick="checkSubscription()">Check Subscription</button>
    </div>

    <div class="section">
        <h2>5. Test Local Notification</h2>
        <button onclick="testLocalNotification()">Test Local Notification</button>
    </div>

    <div class="section">
        <h2>6. Test Firebase Function</h2>
        <input type="text" id="userId" placeholder="Enter User ID" style="width: 300px;">
        <button onclick="testFirebaseFunction()">Test Push via Firebase</button>
        <div id="firebase-result"></div>
    </div>

    <div class="section">
        <h2>7. Debug Information</h2>
        <button onclick="showDebugInfo()">Show All Debug Info</button>
        <pre id="debug-info"></pre>
    </div>

    <script>
        // VAPID Public Key (same as in your app)
        const VAPID_PUBLIC_KEY = 'BDaR2LHlKHBdEgxJe4jCtpuMEdVsy3hVprllCQ0PpMw-sUR123gkAY145aIOH4Wuma0j4T08iRrqZpTSjFmjkGA';

        // Utility functions
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            element.innerHTML = `<div class="${className}">${message}</div>`;
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
            const rawData = atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // 1. Check browser support
        function checkBrowserSupport() {
            const support = {
                serviceWorker: 'serviceWorker' in navigator,
                pushManager: 'PushManager' in window,
                notification: 'Notification' in window,
                promises: 'Promise' in window
            };

            let message = '<h3>Browser Support:</h3><ul>';
            for (const [feature, supported] of Object.entries(support)) {
                message += `<li>${feature}: <span class="status ${supported ? 'success' : 'error'}">${supported ? '‚úÖ Supported' : '‚ùå Not Supported'}</span></li>`;
            }
            message += '</ul>';

            const allSupported = Object.values(support).every(s => s);
            log('browser-support', message, allSupported ? 'success' : 'error');
            
            return allSupported;
        }

        // 2. Check service worker
        async function checkServiceWorker() {
            try {
                if (!('serviceWorker' in navigator)) {
                    log('sw-status', '‚ùå Service Worker not supported', 'error');
                    return false;
                }

                const registration = await navigator.serviceWorker.getRegistration();
                if (!registration) {
                    log('sw-status', '‚ùå No Service Worker registered', 'error');
                    return false;
                }

                const isActive = registration.active !== null;
                const hasController = navigator.serviceWorker.controller !== null;
                
                let message = `<h3>Service Worker Status:</h3>
                    <ul>
                        <li>Registered: ‚úÖ Yes</li>
                        <li>Active: ${isActive ? '‚úÖ Yes' : '‚ùå No'}</li>
                        <li>Controller: ${hasController ? '‚úÖ Yes' : '‚ùå No'}</li>
                        <li>Scope: ${registration.scope}</li>
                        <li>Script URL: ${registration.active?.scriptURL || 'N/A'}</li>
                    </ul>`;

                log('sw-status', message, isActive && hasController ? 'success' : 'warning');
                return isActive && hasController;
            } catch (error) {
                log('sw-status', `‚ùå Error checking service worker: ${error.message}`, 'error');
                return false;
            }
        }

        // 3. Check notification permission
        async function requestPermission() {
            try {
                if (!('Notification' in window)) {
                    log('permission-status', '‚ùå Notifications not supported', 'error');
                    return false;
                }

                const currentPermission = Notification.permission;
                log('permission-status', `Current permission: ${currentPermission}`, 
                    currentPermission === 'granted' ? 'success' : 'warning');

                if (currentPermission === 'granted') {
                    return true;
                }

                const permission = await Notification.requestPermission();
                log('permission-status', `Permission result: ${permission}`, 
                    permission === 'granted' ? 'success' : 'error');
                
                return permission === 'granted';
            } catch (error) {
                log('permission-status', `‚ùå Error requesting permission: ${error.message}`, 'error');
                return false;
            }
        }

        // 4. Create push subscription
        async function createSubscription() {
            try {
                const registration = await navigator.serviceWorker.getRegistration();
                if (!registration) {
                    log('subscription-status', '‚ùå No service worker registration', 'error');
                    return null;
                }

                const applicationServerKey = urlBase64ToUint8Array(VAPID_PUBLIC_KEY);
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: applicationServerKey
                });

                log('subscription-status', `‚úÖ Subscription created successfully!<br>
                    Endpoint: ${subscription.endpoint.substring(0, 50)}...<br>
                    Keys: ${subscription.toJSON().keys ? 'Present' : 'Missing'}`, 'success');
                
                return subscription;
            } catch (error) {
                log('subscription-status', `‚ùå Error creating subscription: ${error.message}`, 'error');
                return null;
            }
        }

        // Check existing subscription
        async function checkSubscription() {
            try {
                const registration = await navigator.serviceWorker.getRegistration();
                if (!registration) {
                    log('subscription-status', '‚ùå No service worker registration', 'error');
                    return null;
                }

                const subscription = await registration.pushManager.getSubscription();
                if (!subscription) {
                    log('subscription-status', '‚ùå No active subscription found', 'warning');
                    return null;
                }

                log('subscription-status', `‚úÖ Active subscription found!<br>
                    Endpoint: ${subscription.endpoint.substring(0, 50)}...<br>
                    Keys: ${subscription.toJSON().keys ? 'Present' : 'Missing'}`, 'success');
                
                return subscription;
            } catch (error) {
                log('subscription-status', `‚ùå Error checking subscription: ${error.message}`, 'error');
                return null;
            }
        }

        // 5. Test local notification
        async function testLocalNotification() {
            try {
                if (Notification.permission !== 'granted') {
                    alert('Please grant notification permission first');
                    return;
                }

                const notification = new Notification('Test Notification', {
                    body: 'This is a test notification from the debug tool',
                    icon: '/icon.png',
                    badge: '/icon.png',
                    tag: 'debug-test'
                });

                setTimeout(() => notification.close(), 5000);
                alert('‚úÖ Local notification sent! Check if you received it.');
            } catch (error) {
                alert(`‚ùå Error sending local notification: ${error.message}`);
            }
        }

        // 6. Test Firebase function
        async function testFirebaseFunction() {
            const userId = document.getElementById('userId').value;
            if (!userId) {
                alert('Please enter a User ID');
                return;
            }

            try {
                log('firebase-result', 'üîÑ Testing Firebase function...', 'warning');
                
                const response = await fetch('https://us-central1-piggybankpwa.cloudfunctions.net/transactions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        UserID: userId,
                        Data: {
                            Amount: 0.01,
                            Category: 'Debug Test',
                            Notes: 'Testing push notifications',
                            Type: 'expense'
                        }
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    log('firebase-result', `‚úÖ Firebase function called successfully!<br>
                        Response: ${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    log('firebase-result', `‚ùå Firebase function error:<br>
                        Status: ${response.status}<br>
                        Response: ${JSON.stringify(result, null, 2)}`, 'error');
                }
            } catch (error) {
                log('firebase-result', `‚ùå Error calling Firebase function: ${error.message}`, 'error');
            }
        }

        // 7. Show all debug info
        async function showDebugInfo() {
            const info = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                serviceWorkerSupport: 'serviceWorker' in navigator,
                pushManagerSupport: 'PushManager' in window,
                notificationSupport: 'Notification' in window,
                notificationPermission: Notification.permission,
                vapidPublicKey: VAPID_PUBLIC_KEY,
                vapidKeyLength: VAPID_PUBLIC_KEY.length,
                currentURL: window.location.href,
                isSecureContext: window.isSecureContext,
                timestamp: new Date().toISOString()
            };

            // Check service worker details
            try {
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration) {
                    info.serviceWorker = {
                        scope: registration.scope,
                        scriptURL: registration.active?.scriptURL,
                        state: registration.active?.state,
                        hasController: !!navigator.serviceWorker.controller
                    };

                    const subscription = await registration.pushManager.getSubscription();
                    if (subscription) {
                        info.pushSubscription = {
                            endpoint: subscription.endpoint,
                            hasKeys: !!subscription.toJSON().keys
                        };
                    }
                }
            } catch (error) {
                info.serviceWorkerError = error.message;
            }

            document.getElementById('debug-info').textContent = JSON.stringify(info, null, 2);
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            checkBrowserSupport();
            checkServiceWorker();
            
            // Check permission status
            if ('Notification' in window) {
                log('permission-status', `Current permission: ${Notification.permission}`, 
                    Notification.permission === 'granted' ? 'success' : 'warning');
            }
        });
    </script>
</body>
</html>